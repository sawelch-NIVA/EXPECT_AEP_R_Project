{
  "hash": "aa0b20fca631d6f494575d446c91580c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Notebook 05 - AEP Network\"\nauthor: \"Sam Welch\"\ndate: \"2025.11.25\"\nlightbox: true\nformat:\n  html:\n    grid:\n      body-width: 1500px\n      sidebar-width: 0px\n    page-layout: full\n    code-fold: true\n    max-width: 4500px\n    fig-format: svg\n    toc: true\n---\n\n<!-- include-in-header:\n  - text\n      <style>\n      /* \"Hide\" TOC sidebar when card is in full-screen mode */\n      .bslib-card[data-full-screen=\"true\"] ~ #quarto-margin-sidebar,\n      body:has(.bslib-card[data-full-screen=\"true\"]) #quarto-margin-sidebar {\n        z-index: 0 !important;\n      }\n      </style> -->\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(STOPeData)\nlibrary(DT)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(forcats)\nlibrary(viridis)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: viridisLite\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(stringr)\nlibrary(ggridges)\nlibrary(ggh4x)\nlibrary(tidygraph)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'tidygraph'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(ggraph)\nlibrary(ggiraph)\nlibrary(leaflet)\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLinking to GEOS 3.13.1, GDAL 3.11.0, PROJ 9.6.0; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(shiny)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'shiny'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:DT':\n\n    dataTableOutput, renderDataTable\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(dplyr)\nlibrary(bslib)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'bslib'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:utils':\n\n    page\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(ggtext)\nlibrary(data.table)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'data.table'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:dplyr':\n\n    between, first, last\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(eDataDRF)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'eDataDRF'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:STOPeData':\n\n    abbreviate_string, altitude_units_vocabulary,\n    analytical_protocols_vocabulary, areas_vocabulary,\n    coordinate_systems_vocabulary, countries_vocabulary,\n    dummy_parameters_vocabulary, environ_compartments_sub_vocabulary,\n    environ_compartments_vocabulary, extraction_protocols_vocabulary,\n    fractionation_protocols_vocabulary, gender_vocabulary,\n    generate_protocol_id, geographic_features_sub_vocabulary,\n    geographic_features_vocabulary, get_dataset_display_name,\n    initialise_biota_tibble, initialise_campaign_tibble,\n    initialise_compartments_tibble, initialise_CREED_data_tibble,\n    initialise_CREED_scores_tibble, initialise_measurements_tibble,\n    initialise_methods_tibble, initialise_parameters_tibble,\n    initialise_references_tibble, initialise_samples_tibble,\n    initialise_sites_tibble, lifestage_vocabulary,\n    measured_categories_vocabulary, measured_flags_vocabulary,\n    measured_types_vocabulary, parameter_types_sub_vocabulary,\n    parameter_types_vocabulary, parameter_unit_vocabulary,\n    protocol_categories_vocabulary, protocol_options_vocabulary,\n    reference_character_limits, sampling_protocols_vocabulary,\n    species_groups_vocabulary, species_names_vocabulary,\n    tissue_types_vocabulary, uncertainty_types_vocabulary\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nhere() starts at C:/Users/SAW/Local Documents/EXPECT AEP/EXPECT_AEP_R_Project\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| label: targets-setup\n#| warning: false\n#| output: false\nlibrary(targets)\n\ndevtools::load_all()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nâ„¹ Loading EXPECT_AEP_R_Project\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: load-data\n# load in any data we need from the targets workflow\nliterature_merged_data <- tar_read(load_literature_pqt)\nliterature_reference_data <- tar_read(reference_data)\nliterature_campaign_data <- tar_read(campaign_data)\nliterature_sites_data <- tar_read(sites_data)\nliterature_qc <- tar_read(data_quality_report)\nwgs84_geo <- tar_read(wgs84_geography)\n\nspecies_names <- eDataDRF::species_names_vocabulary()\nspecies_lookup <- species_names |>\n  with(setNames(SPECIES_COMMON_NAME, SPECIES_NAME))\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| label: themes-and-helpers\n\ncopper_toxicity_thresholds <- tar_read(copper_toxicity_thresholds)\n# Define threshold colors based on the report ----\nthreshold_colours <- c(\n  \"Background (I)\" = \"#0070C0\", # Blue\n  \"Good (II)\" = \"#00B050\", # Green\n  \"Moderate (III)\" = \"#FFC000\", # Yellow\n  \"Poor (IV)\" = \"#FF6600\", # Orange\n  \"Very Poor (V)\" = \"#FF0000\" # Red\n)\n\ncompartment_colours <- c(\n  # Aquatic ----\n  \"Freshwater\" = \"#4A90E2\", # clear blue\n  \"Marine/Salt Water\" = \"#1E5A8E\", # deep ocean blue\n  \"Brackish/Transitional Water\" = \"#6BA5C8\", # mid-blue (between fresh/marine)\n  \"Groundwater\" = \"#2C5F7B\", # darker, subdued blue\n  \"Wastewater\" = \"#8B7355\", # murky brown\n  \"Liquid Growth Medium\" = \"#9FD8CB\", # pale greenish-blue\n  \"Rainwater\" = \"#B3D9FF\", # light sky blue\n  \"Stormwater\" = \"#607D8B\", # grey-blue\n  \"Leachate\" = \"#6B5344\", # dark muddy brown\n  \"Aquatic Sediment\" = \"#EBCF1B\", # your existing yellow\n  \"Porewater\" = \"#7FA0B8\", # muted blue-grey\n  \"Sludge\" = \"#67AB33\", # your existing green\n\n  # Atmospheric ----\n  \"Indoor Air\" = \"#E8F4F8\", # very pale blue-grey\n  \"Outdoor Air\" = \"#87CEEB\", # sky blue\n\n  # Terrestrial ----\n  \"Terrestrial Biological Residue\" = \"#8B6F47\", # organic brown\n  \"Soil H Horizon (Peat)\" = \"#3E2723\", # very dark brown\n  \"Soil O Horizon (Organic)\" = \"#5D4037\", # dark organic brown\n  \"Soil A Horizon (Topsoil)\" = \"#795548\", # medium brown\n  \"Soil E Horizon (Mineral)\" = \"#A1887F\", # light greyish-brown\n  \"Soil S Horizon (Mineral)\" = \"#BCAAA4\", # pale brown-grey\n  \"Soil C Horizon (Parent Material)\" = \"#D7CCC8\", # very pale brown\n  \"Soil R Horizon (Bedrock)\" = \"#9E9E9E\", # grey\n\n  # Biota ----\n  \"Biota, Terrestrial\" = \"#558B2F\", # forest green\n  \"Biota, Aquatic\" = \"#00695C\", # teal\n  \"Biota, Atmospheric\" = \"#B39DDB\", # light purple (birds/insects)\n  \"Biota, Other\" = \"#9C27B0\" # distinct purple\n)\n\n# Helper function for sample sizes\ncalculate_sample_sizes <- function(data) {\n  data |>\n    group_by(\n      REFERENCE_ID,\n      OCEAN_COUNTRY,\n      SITE_GEOGRAPHIC_FEATURE,\n      ENVIRON_COMPARTMENT_SUB\n    ) |>\n    summarise(total_n = sum(MEASURED_N, na.rm = TRUE), .groups = \"drop\")\n}\n\n# Create sub-compartment letter codes ----\nsubcomp_codes <- c(\n  # Aquatic\n  \"Freshwater\" = \"F\",\n  \"Marine/Salt Water\" = \"M\",\n  \"Brackish/Transitional Water\" = \"B\",\n  \"Groundwater\" = \"G\",\n  \"Wastewater\" = \"WW\",\n  \"Liquid Growth Medium\" = \"LGM\",\n  \"Rainwater\" = \"R\",\n  \"Stormwater\" = \"SW\",\n  \"Leachate\" = \"L\",\n  \"Aquatic Sediment\" = \"AS\",\n  \"Porewater\" = \"P\",\n  \"Sludge\" = \"Sl\",\n  # Atmospheric\n  \"Indoor Air\" = \"IA\",\n  \"Outdoor Air\" = \"OA\",\n  # Terrestrial\n  \"Terrestrial Biological Residue\" = \"TBR\",\n  \"Soil H Horizon (Peat)\" = \"H\",\n  \"Soil O Horizon (Organic)\" = \"O\",\n  \"Soil A Horizon (Topsoil)\" = \"A\",\n  \"Soil E Horizon (Mineral)\" = \"E\",\n  \"Soil S Horizon (Mineral)\" = \"S\",\n  \"Soil C Horizon (Parent Material)\" = \"C\",\n  \"Soil R Horizon (Bedrock)\" = \"R\",\n  # Biota\n  \"Biota, Terrestrial\" = \"BT\",\n  \"Biota, Aquatic\" = \"BA\",\n  \"Biota, Atmospheric\" = \"BAm\",\n  \"Biota, Other\" = \"BO\"\n)\n```\n:::\n\n\n# Network Diagram\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n#| label: setup-network-diagram\n#| fig-width: 16\n#| fig-height: 12\n\nunique_compartments_and_sites <- literature_merged_data |>\n  select(\n    SITE_GEOGRAPHIC_FEATURE,\n    SITE_GEOGRAPHIC_FEATURE_SUB,\n    ENVIRON_COMPARTMENT,\n    ENVIRON_COMPARTMENT_SUB,\n    MEASURED_N\n  ) |>\n  distinct() |>\n  filter(if_all(everything(), ~ !is.na(.))) |>\n  group_by(\n    SITE_GEOGRAPHIC_FEATURE,\n    SITE_GEOGRAPHIC_FEATURE_SUB,\n    ENVIRON_COMPARTMENT,\n    ENVIRON_COMPARTMENT_SUB\n  ) |>\n  reframe(sum_n = sum(MEASURED_N)) |>\n  mutate(compartment_name_n = glue::glue(\"{ENVIRON_COMPARTMENT_SUB}\\n{sum_n}\"))\n\n\n# TODO: This is very speculative and just generated by AI. I haven't yet reviewed it to see what's missing.\n# Copper flow network edges ----\ncopper_flow_edges <- tribble(\n  ~from                         , ~to                           , ~flow_type                , ~plausibility , ~magnitude   , ~evidence_quality , ~description                                                ,\n\n  # Atmospheric deposition to surface waters ----\n  \"Atmospheric\"                 , \"Freshwater\"                  , \"deposition\"              , 0.95          , \"medium\"     , \"high\"            , \"Wet and dry deposition from atmospheric particulates\"      ,\n  \"Atmospheric\"                 , \"Brackish/Transitional Water\" , \"deposition\"              , 0.95          , \"medium\"     , \"high\"            , \"Wet and dry deposition to coastal/estuarine waters\"        ,\n  \"Atmospheric\"                 , \"Aquatic Sediment\"            , \"deposition\"              , 0.90          , \"low\"        , \"medium\"          , \"Direct deposition to exposed sediments\"                    ,\n  \"Atmospheric\"                 , \"Soil O Horizon (Organic)\"    , \"deposition\"              , 0.95          , \"medium\"     , \"high\"            , \"Atmospheric deposition to terrestrial surfaces\"            ,\n\n  # Terrestrial to aquatic flows ----\n  \"Soil O Horizon (Organic)\"    , \"Freshwater\"                  , \"runoff\"                  , 0.95          , \"high\"       , \"high\"            , \"Surface runoff and leaching from soils\"                    ,\n  \"Soil O Horizon (Organic)\"    , \"Groundwater\"                 , \"percolation\"             , 0.85          , \"medium\"     , \"medium\"          , \"Downward migration through soil profile\"                   ,\n  \"Biota, Terrestrial\"          , \"Soil O Horizon (Organic)\"    , \"excretion_decomposition\" , 0.90          , \"low\"        , \"medium\"          , \"Excretion and decomposition of terrestrial organisms\"      ,\n\n  # Groundwater to surface water ----\n  \"Groundwater\"                 , \"Freshwater\"                  , \"baseflow\"                , 0.90          , \"medium\"     , \"high\"            , \"Groundwater discharge to streams/rivers\"                   ,\n  \"Groundwater\"                 , \"Brackish/Transitional Water\" , \"discharge\"               , 0.75          , \"low\"        , \"medium\"          , \"Submarine groundwater discharge to coastal waters\"         ,\n\n  # Freshwater flows ----\n  \"Freshwater\"                  , \"Brackish/Transitional Water\" , \"advection\"               , 0.95          , \"high\"       , \"high\"            , \"River discharge to estuaries\"                              ,\n  \"Freshwater\"                  , \"Aquatic Sediment\"            , \"sedimentation\"           , 0.95          , \"high\"       , \"high\"            , \"Particulate settling from water column\"                    ,\n  \"Freshwater\"                  , \"Biota, Aquatic\"              , \"uptake\"                  , 0.95          , \"medium\"     , \"high\"            , \"Bioaccumulation by freshwater organisms\"                   ,\n\n  # Brackish/transitional water flows ----\n  \"Brackish/Transitional Water\" , \"Aquatic Sediment\"            , \"sedimentation\"           , 0.95          , \"high\"       , \"high\"            , \"Particulate settling in estuarine environments\"            ,\n  \"Brackish/Transitional Water\" , \"Biota, Aquatic\"              , \"uptake\"                  , 0.95          , \"medium\"     , \"high\"            , \"Bioaccumulation by estuarine/coastal organisms\"            ,\n\n  # Sediment processes ----\n  \"Aquatic Sediment\"            , \"Freshwater\"                  , \"resuspension\"            , 0.85          , \"medium\"     , \"high\"            , \"Sediment resuspension and porewater release\"               ,\n  \"Aquatic Sediment\"            , \"Brackish/Transitional Water\" , \"resuspension\"            , 0.85          , \"medium\"     , \"high\"            , \"Sediment resuspension in coastal/estuarine areas\"          ,\n  \"Aquatic Sediment\"            , \"Biota, Aquatic\"              , \"uptake\"                  , 0.90          , \"low\"        , \"medium\"          , \"Benthic organism uptake from sediments\"                    ,\n  \"Aquatic Sediment\"            , \"Groundwater\"                 , \"diagenesis\"              , 0.70          , \"low\"        , \"low\"             , \"Deep burial and diagenetic processes\"                      ,\n\n  # Biota cycling ----\n  \"Biota, Aquatic\"              , \"Aquatic Sediment\"            , \"excretion_decomposition\" , 0.95          , \"medium\"     , \"high\"            , \"Fecal pellets, mortality, decomposition\"                   ,\n  \"Biota, Aquatic\"              , \"Freshwater\"                  , \"excretion\"               , 0.90          , \"low\"        , \"medium\"          , \"Dissolved excretion by aquatic organisms\"                  ,\n  \"Biota, Aquatic\"              , \"Brackish/Transitional Water\" , \"excretion\"               , 0.90          , \"low\"        , \"medium\"          , \"Dissolved excretion in coastal waters\"                     ,\n  \"Biota, Aquatic\"              , \"Biota, Terrestrial\"          , \"trophic_transfer\"        , 0.80          , \"low\"        , \"medium\"          , \"Predation by terrestrial organisms (e.g., birds, mammals)\" ,\n\n  # Wastewater flows ----\n  \"Wastewater\"                  , \"Freshwater\"                  , \"discharge\"               , 0.90          , \"high\"       , \"high\"            , \"Treated or untreated wastewater discharge\"                 ,\n  \"Wastewater\"                  , \"Brackish/Transitional Water\" , \"discharge\"               , 0.80          , \"medium\"     , \"medium\"          , \"Coastal wastewater discharge\"                              ,\n  \"Wastewater\"                  , \"Sludge\"                      , \"treatment\"               , 0.95          , \"high\"       , \"high\"            , \"Copper partitioning to sludge during treatment\"            ,\n\n  # Sludge applications ----\n  \"Sludge\"                      , \"Soil O Horizon (Organic)\"    , \"application\"             , 0.85          , \"medium\"     , \"medium\"          , \"Agricultural application of biosolids\"                     ,\n  \"Sludge\"                      , \"Freshwater\"                  , \"discharge\"               , 0.60          , \"low\"        , \"low\"             , \"Illegal or emergency discharge (historical)\"               ,\n\n  # Terrestrial-atmospheric ----\n  \"Soil O Horizon (Organic)\"    , \"Atmospheric\"                 , \"resuspension\"            , 0.70          , \"low\"        , \"low\"             , \"Wind erosion and dust generation\"                          ,\n  \"Biota, Terrestrial\"          , \"Atmospheric\"                 , \"volatilization\"          , 0.40          , \"negligible\" , \"low\"             , \"Unlikely for copper but included for completeness\"\n)\n\n# Add reverse flow indicators for bidirectional processes if needed ----\n# don't work yet\n# copper_flow_edges |> left_join(unique_compartments_and_sites |> select(ENVIRON_COMPARTMENT_SUB, compartment_name_n), by = \"ENVIRON_COMPARTMENT_SUB\")\n\n# Summary statistics ----\n# copper_flow_edges |>\n#   count(flow_type, sort = TRUE)\n\n# copper_flow_edges |>\n#   count(magnitude)\n\n# Then plot\ngraph <- as_tbl_graph(copper_flow_edges)\n```\n:::\n\n\n\n::: {#cell-fig-network-diagram .cell width='20'}\n\n```{.r .cell-code .hidden}\n#| warning: false\n#| width: 20\n#| label: fig-network-diagram\n\nggraph(graph, layout = \"tree\") +\n  geom_edge_diagonal2(\n    aes(label = flow_type),\n    colour = \"darkgrey\",\n    label_colour = \"black\",\n    strength = 0.8,\n    check_overlap = TRUE,\n    angle_calc = \"along\",\n    arrow = arrow(length = unit(4, 'mm')),\n    start_cap = circle(10, 'mm'),\n    end_cap = circle(10, 'mm')\n  ) +\n  geom_node_point(size = 20, aes(colour = name)) +\n  geom_node_text(aes(label = str_wrap(name, 10)), size = 3, ) +\n  scale_fill_manual(values = compartment_colours) +\n  theme_void() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: No shared levels found between `names(values)` of the manual scale and the\ndata's fill values.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](NB05-network_files/figure-html/fig-network-diagram-1.svg){#fig-network-diagram}\n:::\n:::\n\n",
    "supporting": [
      "NB05-network_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}