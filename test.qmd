---
title: "EXPECT Copper AEP"
author: "Sam Welch"
date: "2025.11.25"
lightbox: true
format: 
  html:
    page-layout: full
    code-fold: true
    body-width: 900px
    fig-format: svg
---

```{r}
#| label: targets-setup
#| warning: false
#| message: false
source("_targets.R")
tar_make()
# we still need to load all the other packages again so we can use them here
load_all_requirements <- function(skip_stopedata_update = FALSE) {
  if (skip_stopedata_update) {
    tryCatch(
      install_local("C:/Users/SAW/Documents/STOPeData_0.0.0.9006.tar.gz"),
      error = function(e) {
        "This probably isn't working because STOPeData_0.0.0.9006.tar.gz isn't detected. 
      And it won't work unless you're me, because I hardcoded the file path."
      }
    )
  }
  sapply(
    X = c(
      "STOPeData", # make sure this is up to date (i.e. ask Sam. if you are Sam, ask yourself.)
      "sf",
      "arrow",
      "tidyverse",
      "sfhelper",
      "rnaturalearth",
      "rnaturalearthdata",
      "mapproj",
      "ggspatial",
      "shadowtext",
      "ggrepel",
      "rlang",
      "data.table",
      "dtplyr",
      "leaflet",
      "janitor",
      "shiny",
      "readxl",
      "purrr",
      "qs2",
      "units",
      "targets",
      "glue",
      "ggraph",
      "tidygraph",
      "esquisse",
      "forcats",
      "viridis",
      "DT",
      "ggridges"
    ),
    FUN = library,
    character.only = TRUE
  )

  `%notin%` <- purrr:::negate(`%in%`)
  devtools::load_all()

  # load data and set status in global environment
  main_table <<- arrow::read_parquet("data/clean/literature_data.parquet")
  requirements_loaded <<- TRUE
}
load_all_requirements()
```

## Dataset Preview

Give a vague preview of the dataset

```{r}
#| label: fig-dataset
#| fig-cap: "Temperature and ozone level."
#| warning: false

```

## Papers Analysed

Quick summary of papers and what they contain

```{r}
#| label: table_paper_summaries
#| warning: false
tar_read(load_literature_pqt) |>
  dplyr::left_join(tar_read(reference_data)) |>
  dplyr::left_join(tar_read(campaign_data)) |>
  dplyr::group_by(
    TITLE,
    YEAR,
    AUTHOR,
    CAMPAIGN_COMMENT
  ) |>
  dplyr::reframe(SUM_N = sum(MEASURED_N)) |>
  datatable(options = list(pageLength = 5, lengthMenu = c(5, 10, 15, 20)))

```

@fig_paper_subcompartments explores paper quantity and analysed compartments..

```{r}
#| label: fig_paper_subcompartments
#| fig-cap: "Number of environmental sub-compartments sampled per paper."
#| warning: false
tar_read(plot_paper_subcompartments)
```

```{r}
#| label: fig_paper_species
#| fig-cap: "Number of environmental sub-compartments sampled per paper."
#| warning: false
tar_read(plot_paper_species)
```


## Sampling Sites/Map

```{r}
#| label: fig_map
#| fig-cap: "Number of environmental sub-compartments sampled per paper."
#| warning: false
tar_read(wgs84_literature_map)
```

## Breakdown by environmental compartment
We're most interested in qualifying the concentrations in each compartment, so this is probably the right place to start. How do we plot 

### Freshwater

```{r}
#| label: freshwater_distributions
#| fig-cap: "Number of environmental sub-compartments sampled per paper."
#| warning: false

library(ggplot2)

filter(main_table, ENVIRON_COMPARTMENT == "Aquatic") |>
  ggplot() +
  aes(
    x = SITE_CODE,
    y = MEASURED_VALUE_STANDARD,
    fill = ENVIRON_COMPARTMENT_SUB
  ) +
  geom_function(fun = dnorm) +
  scale_fill_hue(direction = 1) +
  scale_y_continuous(trans = "log10") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90L)) +
  facet_wrap(vars(REFERENCE_ID), scales = "free_x", nrow = 1L)


ggplot() +
  stat_function(fun = ~ dnorm(.x, 34, 4.5), geom = "area") +
  xlim(c(20, 48))
```




```{r}
#| label: ridgeplot
library(tidyverse)
pak::pak("ggridges")
library(ggridges)

# Example data ----
## Distribution parameters ----
dist_params <- tibble(
  species = c("Species A", "Species B", "Species C"),
  mean = c(45, 55, 50),
  sd = c(8, 12, 10),
  n = c(100, 150, 120)
)

## Thresholds ----
thresholds <- generate_copper_thresholds() |>
  filter(ENVIRON_COMPARTMENT == "Aquatic")

# Generate density data ----
## Create x values and calculate densities ----
x_range <- seq(
  from = min(dist_params$mean - 4 * dist_params$sd),
  to = max(dist_params$mean + 4 * dist_params$sd),
  length.out = 1001
)

aquatic_data <- main_table |>
  filter(ENVIRON_COMPARTMENT == "Aquatic") |>
  filter(UNCERTAINTY_TYPE == "Standard Deviation", !is.na(MEASURED_N)) |>
  mutate(SD_STANDARDISED = UNCERTAINTY_UPPER_STANDARD - MEASURED_VALUE_STANDARD)

aquatic_data_dists <- aquatic_data |>
  rowwise() |>
  group_by(SAMPLE_ID) |>
  reframe(
    n = MEASURED_N, # keep n for labeling
    x = x_range,
    density = dnorm(
      x_range,
      mean = MEASURED_VALUE_STANDARD,
      sd = SD_STANDARDISED
    )
  )

# Create labels with sample size ----
species_labels <- dist_params |>
  mutate(label = paste0(species, " (n=", n, ")")) |>
  select(species, label) |>
  deframe()

# Visualization ----
## Ridgeline density plot with thresholds ----
ggplot(aquatic_data_dists, aes(x = x, y = SAMPLE_ID, height = density)) +
  geom_ridgeline(fill = "lightblue", alpha = 0.7, scale = 100) +
  # Add vertical lines for thresholds
  geom_vline(
    data = thresholds |>
      filter(ENVIRON_COMPARTMENT_SUB %in% vars(ENVIRON_COMPARTMENT_SUB)), # only use relevant thresholds
    aes(xintercept = THRESHOLD_VALUE),
    linetype = "dashed",
    color = "red",
    linewidth = 0.8,
    alpha = 0.6
  ) +
  labs(
    x = "Value",
    y = ""
  ) +
  theme_ridges()

```

```{r}
# Create the expanded dataset using the Stack Overflow pattern
aquatic_ridge_data <- aquatic_data |>
  filter(MEASURED_UNIT_STANDARD == "mg/L") |>

  mutate(
    low = MEASURED_VALUE_STANDARD - 3 * SD_STANDARDISED,
    high = MEASURED_VALUE_STANDARD + 3 * SD_STANDARDISED
  ) |>
  uncount(100, .id = "row") |>
  mutate(
    x = (1 - row / 100) * low + row / 100 * high,
    density = dnorm(x, MEASURED_VALUE_STANDARD, SD_STANDARDISED)
  )

# Create the ridge plot
ggplot(aquatic_ridge_data, aes(x = x, y = SAMPLE_ID, height = density)) +
  geom_ridgeline(
    aes(fill = ENVIRON_COMPARTMENT_SUB),
    alpha = 0.7,
    scale = 0.5
  ) +
  geom_vline(
    data = thresholds |>
      filter(
        ENVIRON_COMPARTMENT_SUB %in% c("Freshwater", "Wastewater"),
        THRESHOLD_VALUE <= 1
      ), # only use relevant thresholds, not above 1 mg/L (purely because our data currently doesn't exceed that)
    aes(xintercept = THRESHOLD_VALUE, color = THRESHOLD_CLASS),
    linetype = "dashed",
    linewidth = 0.8,
    alpha = 0.6
  ) +
  labs(
    x = "Concentration (mg/L)",
    y = "Sample ID"
  ) +
  theme_ridges() +
  facet_wrap(
    facets = vars(ENVIRON_COMPARTMENT_SUB),
    ncol = 1,
    scales = "free_y",
    space = "free_y"
  )
plotly::ggplotly()

```